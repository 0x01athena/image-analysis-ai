import OpenAI from 'openai';
import fs from 'fs';
import path from 'path';
import dotenv from 'dotenv';

// Load environment variables
dotenv.config({ path: path.join(__dirname, '../../.env') });

export interface OpenAIProductAnalysis {
    title: string[];
    category: string;
    categoryList: string[];
    level: 'A' | 'B' | 'C';
    measurement?: string;
    measurement_type?: { foreign: string; japanese: string };
    condition?: string;
    type?: string;
    shop1?: string;
    shop2?: string;
    shop3?: string;
}

export class OpenAIService {
    private client: OpenAI;

    constructor() {
        this.client = new OpenAI({
            apiKey: process.env.OPENAI_API_KEY || '',
            timeout: 120000
        });
    }

    /**
     * Analyze product images using OpenAI Vision API
     */
    async analyzeProductImages(productId: string, imageFilenames: string[]): Promise<OpenAIProductAnalysis> {
        try {
            // Read and encode images
            const imageContents = await Promise.all(
                imageFilenames.map(async (filename) => {
                    const imagePath = path.join(__dirname, '../../public/images', filename);
                    const imageBuffer = fs.readFileSync(imagePath);
                    return {
                        type: "image_url" as const,
                        image_url: {
                            url: `data:image/jpeg;base64,${imageBuffer.toString('base64')}`,
                            detail: "high" as const
                        }
                    };
                })
            );

            const prompt = `
あなたは日本のECサイト（楽天市場、Yahoo!ショッピング、メルカリなど）向けの商品カタログ作成と商品タイトル生成の専門家です。
以下の画像を分析し、製品情報を詳細に抽出してJSON形式で出力してください。出力は必ず日本語で行ってください。

---

### 1. 生成ランク (level)
画像認識結果および抽出情報の正確性に基づいて、以下のルールでランクを判定してください。

ランク判定ルール：
Aランク → 画像から ブランド名 と 型番（モデル名） が正確に特定でき、かつ サイズ情報が正常に抽出・日本サイズへ変換できた 場合。
Bランク → 以下のいずれかに該当する場合。
　・画像内容に基づかず、外部情報や推測に依存している場合。
　・ブランドタグが写っていない、またはブランド名が不明確な場合。
　・型番（モデル名）が検出できなかった場合。
　・靴カテゴリでモデル名が検出できない場合（靴は必ずモデル名が存在するため、欠落＝B判定）。
　・サイズ情報が抽出できない、または日本サイズに変換できない場合。
　・出力が「作成中」または空白の場合。

出力形式：
必ず "A" または "B" のいずれか1文字のみを出力してください。
---

### 2. サイズ形式変換 (measurement_type)
画像およびラベル（タグ）からサイズ情報を抽出し、該当する国のサイズ表記を日本サイズに変換してください。

**ルール：**
- サイズ表記が外国サイズ（イタリア、フランス、アメリカ、イギリス、EUなど）の場合は、対応する日本サイズに変換します。
- サイズ表記がすでに日本サイズ（S/M/L/LLなど）の場合は変換せずそのまま出力します。
- 結果は以下の形式のオブジェクト（measurement_type）で出力してください。

**出力フォーマット：**
    measurement_type: {
        "foreign": "IT 48",
        "japanese": "日本サイズM"
    }

**補足ルール：**
- 日本ブランドや日本サイズの場合は、「foreign」は空文字とし、「japanese」のみ出力します。
  例：
  measurement_type: {
    "foreign": "",
    "japanese": "日本サイズL"
  }

---

3. タイトル生成(title)
画像とラベル（タグ・型番）から**正確な正式名称（または一般名称）**を推定し、
日本のECサイトで使用される自然なタイトルを5件作成してください。

**生成ルール:**
- ブランドタグ、モデル番号、商品画像を視覚的に読みます。
- ブランド+製品番号でウェブ検索し、結果を確認して正式名称を特定。
- 検索結果のイメージと対照し、色・素材・カテゴリが一致するものを採用。
- 自信順に5件生成。
- 各タイトルは40～80文字程度で、日本のECサイトで一般的な表現を使用。
- 確定できない情報の推測は禁止（「同じ」、「写真通り」などは使用しない）。
- 必ず商品の性別を判別して生成する。

**ブランド名表記と文字数制限ルール**
外国ブランド名は必ずカタカナ表記＋英字表記をすべて生成する。
例: ルイ・ヴィトン Louis Vuitton, グッチ Gucci, シャネル Chanel

タイトル全体の総文字数が65文字を超える場合
カタカナ表記を完全に削除し、英字表記のみを残す。
例:
通常→ルイ・ヴィトン Louis Vuitton モノグラム トートバッグ
65文字を超える→Louis Vuittonモノグラムトートバッグ

文字数判定はタイトル全体（ブランド＋型番＋商品名＋サイズ＋カラーを含む）で行う。
- 日本ブランドの場合はカタカナ表記だけで表記。
- 色は「ブラック系」「ベージュ系」など「◯◯系」で統一。

**性別カテゴリ（対象）**
- 画像またはタグの情報から、商品が「男性」、「女性」、「子供」のいずれかを決定する。
- 服の形、サイズ表記（例：MENS / WOMENS / BOYS / GIRLSなど）、デザイン要素を参考に判定。
- 生成されるすべての候補タイトルのトルの末尾に必ず対象を明記する（例：「メンズ」、「レディース」、「キッズ」）。
例:
「ルイ・ヴィトン Louis Vuitton モノグラム トートバッグ レディース」
「ナイキナイキスウェットパーカーメンズ」


のような記号は含まれません: 【, 】。
---

### 4. カテゴリ (category)
常に '' を返してください。

### 5. カテゴリーリスト (categoryList)

以下のJSONは全てのカテゴリ構造（最上位～最下位）を表します。
提供された商品情報（タイトル、説明、ブランド、画像など）に基づき、
該当商品に最も適したカテゴリパスを1つ選択し、配列形式で出力してください。

【カテゴリー構造データ】
{
  "アンティーク、コレクション": {
    "雑貨": ["キーホルダー", "喫煙グッズ"]
  },
  "事務、店舗用品": {
    "文房具": ["筆記用具"]
  },
  "スポーツ、レジャー": {
    "キャンプ、アウトドア用品": ["かばん、バッグ"],
    "スポーツ別": ["ゴルフ"],
    "スポーツウエア": ["男性用", "女性用", "男女兼用", "子ども用"],
    "アウトドアウエア": ["ブランド別", "男性用", "女性用", "子ども用", "服飾小物"],
    "スポーツサングラス": [
      "OGK", "zerorh+", "アーネット", "アックス", "アディダス",
      "オークリー", "コールマン", "スパイ", "スポルディング", "スワンズ",
      "ナイキ", "ブラックフライ", "ブリコ", "ルディプロジェクト", "レイバン",
      "その他"
    ]
  },
  "ファッション": {
    "ブランド別": [
      "あ","い","う","え","お","か","き","く","け","こ","さ","し","す","せ/そ","た/ち/つ",
      "て","と","な～の","は","ひ","ふ","へ","ほ","ま","み","む/め/も","や/ゆ/よ","ら","り","る","れ","ろ","わ"
    ],
    "レディースファッション": [
      "コート","ジャケット、上着","カーディガン","アンサンブルニット","ニット、セーター",
      "ベスト","トレーナー","カットソー","シャツ、ブラウス","チュニック","Tシャツ",
      "ポロシャツ","キャミソール","タンクトップ","チューブトップ、ベアトップ",
      "ワンピース","スカート","パンツ、スラックス","デニム、ジーンズ","ワークパンツ、ペインターパンツ",
      "ショートパンツ","サブリナパンツ、カプリパンツ","サロペット、オーバーオール",
      "キュロット","チノパン","サルエルパンツ","スーツ","フォーマル","レギンス、トレンカ",
      "インナーウエア","ナイトウエア、パジャマ","水着","マタニティウエア","その他"
    ],
    "レディースバッグ": [
      "ショルダーバッグ","トートバッグ","ハンドバッグ","ポーチ","ウエストバッグ",
      "クラッチバッグ、パーティバッグ","セカンドバッグ","バスケット、籐かご","バニティバッグ",
      "ブリーフケース、書類かばん","ボストンバッグ","ボディバッグ","ポシェット","リュックサック、デイパック","巾着"
    ],
    "レディースシューズ": ["ウォーキングシューズ","サンダル","スニーカー","バレエシューズ","パンプス","ブーツ","ミュール","ローファー、モカシン","長靴、レインシューズ","その他"],
    "女性和服、着物": ["かんざし","きんちゃく、バッグ","コート、道中着","下駄、草履","小紋","色無地","振袖","帯","紬、お召","付下げ","訪問着","浴衣","留袖","長襦袢","和装小物","アンティーク","その他"],
    "ファッション小物": ["財布","定期入れ","キーケース","うちわ","扇子","ふくさ","風呂敷","雨傘","日傘","帽子","サングラス","エプロン","サスペンダー","ティッシュカバー","ネクタイ","ハンカチ","バンダナ","ベルト"],
    "メンズファッション": [
      "コート","ジャケット、上着","カーディガン","ニット、セーター","ベスト","トレーナー","シャツ","ポロシャツ","Tシャツ",
      "タンクトップ","ジーンズ","パンツ、スラックス","ワークパンツ、ペインターパンツ","チノパン","ショートパンツ",
      "オーバーオール","サルエルパンツ","スーツ","インナーウエア","パジャマ","フォーマル","水着","その他"
    ],
    "メンズバッグ": ["ショルダーバッグ","ブリーフケース、書類かばん","リュックサック、デイパック","ウエストバッグ","トートバッグ","セカンドバッグ","ハンドバッグ","ボストンバッグ","ボディバッグ"],
    "メンズシューズ": ["スニーカー","サンダル","ブーツ","ローファー、スリッポン","ビジネスシューズ","デッキシューズ","ウォーキングシューズ","長靴、レインシューズ","その他"],
    "男性和服、着物": ["一般","下駄、草履","作務衣","甚平","帯","浴衣","長襦袢","和装小物"],
    "男女兼用バッグ": ["ウエストバッグ","エコバッグ","ショルダーバッグ","トートバッグ","ボストンバッグ","メディスンバッグ","リュックサック、デイパック"],
    "キッズ、ベビーファッション": ["ブランド別","子ども服（女の子用）","子ども服（男女兼用）","子ども用シューズ","ベビー服","ベビーシューズ","ベビー用ファッション小物"],
    "ハンドメイド": ["ベビー用","子ども用","女性用","男性用","服飾小物","かばん、バッグ"]
  },
  "アクセサリー、時計": {
    "メンズ腕時計": ["アナログ（クォーツ式）","アナログ（自動巻き）","アナログ（手巻き）","デジタル"],
    "レディース腕時計": ["アナログ（クォーツ式）","アナログ（自動巻き）","アナログ（手巻き）","デジタル"],
    "キャラクター腕時計": ["その他"],
    "ブランドアクセサリー": [
      "A＆G","アーカー","アガタ","アガット","アバクロンビー＆フィッチ","Q-pot","カルティエ","カレラ イ カレラ","ガボール","クリスチャン・ディオール","エルメス","クレージュ","クレイジーピッグ","クロムハーツ","グッチ","コーチ","コム サ デ モード","ゴローズ","シャネル","ショーメ","ショパール","ジバンシイ","ジャスティンデイビス","ジャムホームメイド","ジョージ・ジェンセン","スタージュエリー","スワロフスキー","タテオシアン","ダミーニ","ダンヒル","ティファニー","デビアス","トラヴィスワーカー","ドルチェ＆ガッバーナ","田崎真珠","ナンバーナイン","ニナリッチ","ノジェス","ハリー・ウィンストン","バカラ","ビルウォールレザー","ピアジェ","フォリフォリ","フリースタイル","ブシュロン","ブラッディーマリー","ブルーム","ブルガリ","ポール･スミス","ポメラート","ポンテヴェキオ","ヴァンクリーフ＆アーペル","ヴァンドーム青山","ヴィヴィアンウエストウッド","ミキモト","ミハエル・ネグリン","ミリアム・ハスケル","4℃","ルイ・ヴィトン","レナードカムホート、ロンワンズ","ロードキャメロット","ローリーロドキン","ロイヤルオーダー"
    ],
    "レディースアクセサリー": ["ネックレス、ペンダント","ペンダントトップ、チャーム","ネックレス（チェーンのみ）","チョーカー","指輪","ピアス","イヤリング","ブレスレット、バングル","アンクレット","裸石、ルース","ブローチ","ヘアアクセサリー","コサージュ","ボディピアス","アクセサリーケース"],
    "メンズアクセサリー": ["ネックレス","ペンダント","ペンダントトップ、チャーム","ブレスレット、バングル","指輪","キーチェーン、ウォレットチェーン","タイピン","ピアス","ボディピアス","バックル","マネークリップ","ウイッグ","チョーカー","その他"],
    "ブランド腕時計": ["あ行","か行","さ行","た行","な行","は行","ま行、や行","ら行"]
  },
  "ビューティー、ヘルスケア": {
    "めがね、コンタクト": ["めがね","めがねケース","老眼鏡"]
  },
  "携帯電話、スマートフォン": {
    "アクセサリー": ["iPhone用ケース"]
  }
}

【出力形式】
必ず以下の形式で出力してください：
[“大カテゴリー”, “中カテゴリー”, ‘小カテゴリー’, “下位カテゴリー”]

【ルール】
1. JSONに存在しないカテゴリを新規作成しない。
2. 商品名・説明・画像等から判断し、最も近いカテゴリパスを選択する。
3. ブランド名やアイテム名が複数のカテゴリに該当する場合、
   - 優先順位は「商品種類」＞「ブランド」＞「素材」＞「色」。
4. 出力は配列（JSON形式）1行のみ。不要な説明文は不要。
5. 確信がなくても最も近いカテゴリーを必ず返す。
6. 結果が曖昧な場合、「その他」を含むカテゴリーを選択する。

例: [“携帯電話、スマートフォン”, ‘アクセサリー’, “iPhone用ケース”]
---

### 6. 採寸 (measurement)
画像の背景に方眼（マス目）模様がある場合、それを採寸の基準として使用する。
各マス目は1cm×1cmの正方形として扱う。
服やアイテムの端から端までのマス目数を数え、おおよその長さをcm単位で推定する。
グリッド線が不明瞭な場合は、目視で最も近い整数cmを推定する。
出力形式は次の通りとする: "着丈:65 肩幅:45 身幅:50 袖丈:20"。
画像から一部のみ測定可能な場合は、判別できる項目のみを出力し、完全に不明な場合は空文字（""）を返す。
推定値は一般的な衣類の範囲内に収め、極端な数値（例: 着丈:200など）は避ける。

例: "着丈:65 肩幅:45 身幅:50 袖丈:20"

---

### 7. コンディション (condition)
常に '' を返してください。

---

### 8. 商品タイプ (type)
画像および商品情報を分析し、以下の商品タイプリストから該当するタイプを1つ選択してください。

**商品タイプリスト：**
- 複数商品
- トップス
- パンツ
- スカート
- ワンピース
- オールインワン
- スカートスーツ
- パンツスーツ
- アンサンブル
- 靴
- ブーツ
- ベルト
- ネクタイ
- 縦横
- 帽子
- バッグ
- ネックレス
- サングラス

**判定ルール：**
- 画像から商品の形状、デザイン、特徴を分析して最も適切なタイプを選択してください。
- 複数の商品が写っている場合は「複数商品」を選択してください。
- 確信が持てない場合でも、最も近いと思われるタイプを必ず選択してください。
- 出力は上記リストのいずれかの文字列をそのまま返してください。

---

### 9〜11. 店舗ID (shop1, shop2, shop3)
それぞれ '' を返してください。

---

### 出力形式
以下のJSON形式で出力してください。
※ **応答に \`\`\`json と \`\`\` を含めないでください。有効な JSON データのみを返します

{
"title": [ "title1", "title2", "title3", "title4", "title5" ],
"level": "A",
"measurement": "",
"measurement_type": {
    "foreign": '',
    "japanese": ""
},
"category": "",
"categoryList": ["事務、店舗用品","文房具","筆記用具"],
"condition": "",
"type": "トップス",
"shop1": "",
"shop2": "",
"shop3": ""
}

---

**重要:**  
- 出力は必ず上記のJSONフォーマット構造を保持すること。  
- 「level」の判定は画像からの抽出精度に基づく。  
- JSON以外の文字（コードフェンス・コメント・説明）は一切禁止。
`;

            const response = await this.client.chat.completions.create({
                model: "gpt-4.1",
                messages: [
                    {
                        role: "user",
                        content: [
                            {
                                type: "text",
                                text: prompt
                            },
                            ...imageContents
                        ]
                    }
                ],
                max_tokens: 2000,
                temperature: 0.3,
            });

            const content = response.choices[0]?.message?.content;

            console.log('OpenAI response:', content);

            if (!content) {
                throw new Error('No response from OpenAI');
            }

            // Parse JSON response
            const analysis = JSON.parse(content) as OpenAIProductAnalysis;

            // Validate required fields
            if (!analysis.title || !Array.isArray(analysis.title) || analysis.title.length === 0 || !analysis.level) {
                throw new Error('Invalid response format from OpenAI');
            }

            // Ensure categoryList exists, default to empty array if not provided
            if (!analysis.categoryList || !Array.isArray(analysis.categoryList)) {
                analysis.categoryList = [];
            }

            return analysis;

        } catch (error) {
            console.error(`Error analyzing product ${productId}:`, error);

            // Return default values if OpenAI fails
            return {
                title: [''],
                category: '',
                categoryList: [],
                level: 'B',
                measurement: '',
                condition: '',
                type: '',
                shop1: '',
                shop2: '',
                shop3: ''
            };
        }
    }

    /**
     * Test OpenAI connection
     */
    async testConnection(): Promise<boolean> {
        try {
            const response = await this.client.chat.completions.create({
                model: "gpt-4.1",
                messages: [{ role: "user", content: "Hello" }],
                max_tokens: 10
            });
            return !!response.choices[0]?.message?.content;
        } catch (error) {
            console.error('OpenAI connection test failed:', error);
            return false;
        }
    }
}

export const openAIService = new OpenAIService();
